<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartRent AI | Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --brand:#6366f1; --brand-d:#4f46e5; --bg:#080d1a;
  --card:rgba(255,255,255,0.04); --border:rgba(255,255,255,0.08);
  --text:#e2e8f0; --muted:#64748b;
}
*{box-sizing:border-box;}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg); color:var(--text); min-height:100vh;
  background-image:
    radial-gradient(ellipse 80% 50% at 20% -20%,rgba(99,102,241,.15) 0,transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%,rgba(139,92,246,.1) 0,transparent 60%);
}
h1,h2,h3,.font-h{font-family:'Syne',sans-serif;}
.glass{background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:20px;}
.ifield{
  background:rgba(15,23,42,.6);border:1px solid var(--border);color:white;
  border-radius:12px;width:100%;padding:12px 16px;font-size:14px;font-weight:500;
  font-family:'DM Sans',sans-serif;transition:border-color .2s,box-shadow .2s;appearance:none;
}
.ifield:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(99,102,241,.15);}
.ifield::placeholder{color:#475569;}
.btn-p{
  background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border-radius:12px;
  font-weight:700;transition:transform .15s,box-shadow .15s;font-family:'Syne',sans-serif;
}
.btn-p:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 20px rgba(99,102,241,.35);}
.btn-p:disabled{opacity:.6;cursor:not-allowed;}

/* BHK btns */
.bhk-btn{padding:10px 0;border-radius:10px;font-size:13px;font-weight:700;border:1px solid var(--border);
  color:var(--muted);background:rgba(15,23,42,.4);cursor:pointer;transition:all .2s;}
.bhk-btn:hover{border-color:var(--brand);color:#a5b4fc;}
.bhk-btn.active{border-color:var(--brand);background:rgba(99,102,241,.15);color:#a5b4fc;}

/* Furnish cards */
.fc{flex:1;padding:9px 6px;border:1px solid var(--border);border-radius:10px;cursor:pointer;
  text-align:center;font-size:11px;font-weight:600;color:var(--muted);
  background:rgba(15,23,42,.4);transition:all .2s;user-select:none;}
.fc:hover{border-color:var(--brand);color:#a5b4fc;}
.fc.active{border-color:var(--brand);background:rgba(99,102,241,.15);color:#a5b4fc;}
.fc .ic{font-size:17px;display:block;margin-bottom:3px;}

/* Persona toggle */
.persona-btn{flex:1;padding:9px 12px;border-radius:10px;font-size:12px;font-weight:700;
  border:1px solid var(--border);color:var(--muted);background:rgba(15,23,42,.4);
  cursor:pointer;transition:all .2s;text-align:center;}
.persona-btn.active-tenant{border-color:#22c55e;background:rgba(34,197,94,.12);color:#4ade80;}
.persona-btn.active-owner{border-color:#f59e0b;background:rgba(245,158,11,.12);color:#fbbf24;}
.persona-btn:hover{border-color:var(--brand);}

/* Chat */
.ai-bubble{background:rgba(30,41,59,.8);border:1px solid var(--border);border-bottom-left-radius:4px;}
.user-bubble{background:#4f46e5;border-bottom-right-radius:4px;}
.shimmer{background:linear-gradient(90deg,#1e293b 25%,#334155 50%,#1e293b 75%);
  background-size:200% 100%;animation:shim 1.5s infinite;}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
.scbar::-webkit-scrollbar{width:4px;}
.scbar::-webkit-scrollbar-thumb{background:#334155;border-radius:10px;}

/* Range slider */
input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:4px;
  background:rgba(99,102,241,.3);outline:none;margin-top:8px;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;
  border-radius:50%;background:#6366f1;cursor:pointer;box-shadow:0 0 0 3px rgba(99,102,241,.2);}

/* Tabs */
.tab-btn{padding:7px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;
  transition:all .2s;color:var(--muted);}
.tab-btn.active{background:rgba(99,102,241,.15);color:#a5b4fc;}
.tab-btn:hover:not(.active){color:var(--text);}

/* Toast */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:#1e293b;border:1px solid var(--border);color:white;
  padding:11px 22px;border-radius:12px;font-size:13px;font-weight:600;
  transition:transform .3s;z-index:9999;white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);}

/* Animated counter */
@keyframes countUp{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
.rent-reveal{animation:countUp .4s ease forwards;}

/* Affordability meter */
.afford-bar{height:6px;border-radius:999px;background:rgba(255,255,255,.1);overflow:hidden;}
.afford-fill{height:100%;border-radius:999px;transition:width .6s ease;}

/* Streaming cursor */
.stream-cursor::after{content:'‚ñã';display:inline-block;animation:blink .7s infinite;color:#6366f1;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* Compare side cards */
.cmp-card{flex:1;background:rgba(15,23,42,.5);border:1px solid var(--border);border-radius:16px;padding:20px;}
.cmp-winner{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.05);}

/* History note */
.note-input{background:transparent;border:none;color:#94a3b8;font-size:12px;
  font-family:'DM Sans',sans-serif;resize:none;width:100%;outline:none;}
.note-input::placeholder{color:#475569;}

/* Locality search */
.loc-search{position:relative;}
.loc-search input{padding-left:36px;}
.loc-search .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none;}

/* Pulse */
@keyframes pulse-out{0%{transform:scale(.8);opacity:1}100%{transform:scale(2);opacity:0}}
.pulse-dot{position:relative;display:inline-block;}
.pulse-dot::before{content:'';position:absolute;inset:0;border-radius:50%;
  background:#22c55e;animation:pulse-out 1.5s ease-out infinite;}
</style>
</head>
<body class="antialiased">

<script id="cities-data" type="application/json">{{ cities | tojson | safe }}</script>
<script id="map-data" type="application/json">{{ cities_map | tojson | safe }}</script>

<!-- NAVBAR -->
<nav class="sticky top-0 z-50 border-b border-white/5 bg-black/30 backdrop-blur-xl">
  <div class="max-w-7xl mx-auto px-6 py-3.5 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
        <i data-lucide="trending-up" class="w-5 h-5 text-white"></i>
      </div>
      <span class="text-lg font-h font-bold tracking-tight">SmartRent<span class="text-indigo-400">AI</span></span>
    </div>

    <div class="hidden md:flex items-center gap-1 bg-white/5 rounded-xl p-1">
      <button class="tab-btn active" onclick="App.switchTab('predict')" id="tab-predict">Predict</button>
      <button class="tab-btn" onclick="App.switchTab('compare')" id="tab-compare">Compare</button>
      <button class="tab-btn" onclick="App.switchTab('history')" id="tab-history">History</button>
    </div>

    <div class="flex items-center gap-3">
      <div class="hidden md:flex flex-col items-end">
        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Signed in as</span>
        <span class="text-sm font-semibold text-slate-200">{{ user_name }}</span>
      </div>
      <a href="/logout" title="Logout" class="p-2 hover:bg-red-500/10 text-slate-400 hover:text-red-400 rounded-lg transition-colors">
        <i data-lucide="log-out" class="w-4 h-4"></i>
      </a>
    </div>
  </div>
</nav>

<main class="max-w-7xl mx-auto py-7 px-6">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PREDICT TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-predict">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- LEFT PANEL -->
    <div class="lg:col-span-4 space-y-5">
      <div class="glass p-6">
        <div class="flex items-center gap-2 mb-5">
          <i data-lucide="sliders-horizontal" class="w-4 h-4 text-indigo-400"></i>
          <h2 class="text-sm font-h font-bold text-white uppercase tracking-wider">Property Parameters</h2>
        </div>

        <div class="space-y-4">
          <!-- City -->
          <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">City</label>
            <div class="relative">
              <select id="city" class="ifield pr-8"></select>
              <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i>
            </div>
          </div>

          <!-- Locality with search -->
          <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Locality</label>
            <div class="loc-search">
              <i data-lucide="search" class="search-icon w-3.5 h-3.5"></i>
              <input type="text" id="loc-search" placeholder="Search locality..." class="ifield" autocomplete="off">
            </div>
            <div class="relative mt-1">
              <select id="locality" class="ifield pr-8" size="1"></select>
              <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i>
            </div>
          </div>

          <!-- BHK -->
          <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Configuration</label>
            <div class="grid grid-cols-4 gap-1.5">
              <button class="bhk-btn" data-val="1">1 BHK</button>
              <button class="bhk-btn active" data-val="2">2 BHK</button>
              <button class="bhk-btn" data-val="3">3 BHK</button>
              <button class="bhk-btn" data-val="4">4 BHK</button>
            </div>
          </div>

          <!-- Area -->
          <div class="space-y-1.5">
            <div class="flex justify-between">
              <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Area</label>
              <span id="area-display" class="text-xs font-bold text-indigo-400">1000 sqft</span>
            </div>
            <input type="range" id="area-slider" min="200" max="5000" step="50" value="1000">
            <input type="number" id="area" value="1000" class="ifield mt-2 text-sm" placeholder="sqft">
          </div>

          <!-- Furnishing -->
          <div class="space-y-1.5">
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Furnishing</label>
            <div class="flex gap-1.5">
              <div class="fc" data-val="Unfurnished"><span class="ic">ü™ë</span>Unfurnished</div>
              <div class="fc active" data-val="Semi-Furnished"><span class="ic">üõãÔ∏è</span>Semi</div>
              <div class="fc" data-val="Furnished"><span class="ic">üè†</span>Furnished</div>
            </div>
          </div>

          <button id="predict-btn" class="btn-p w-full py-4 flex items-center justify-center gap-2 text-sm mt-1">
            <i data-lucide="sparkles" class="w-4 h-4"></i>Generate Valuation
          </button>
        </div>
      </div>

      <!-- Affordability Calculator -->
      <div class="glass p-6">
        <div class="flex items-center gap-2 mb-4">
          <i data-lucide="calculator" class="w-4 h-4 text-amber-400"></i>
          <h3 class="text-sm font-h font-bold text-white">Affordability Check</h3>
        </div>
        <div class="space-y-3">
          <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Monthly Income (‚Çπ)</label>
            <input type="number" id="salary-input" placeholder="e.g. 150000" class="ifield mt-1.5 text-sm" oninput="App.calcAffordability()">
          </div>
          <div id="afford-result" class="hidden">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs text-slate-400">Rent-to-Income</span>
              <span id="afford-pct" class="text-sm font-h font-bold"></span>
            </div>
            <div class="afford-bar">
              <div id="afford-fill" class="afford-fill"></div>
            </div>
            <p id="afford-msg" class="text-xs text-slate-500 mt-2 leading-relaxed"></p>
          </div>
          <p id="afford-hint" class="text-xs text-slate-600">Enter your income to check if this rent is within healthy limits.</p>
        </div>
      </div>

      <!-- Market Pulse -->
      <div class="glass p-5 border-indigo-500/20" style="background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(99,102,241,.02))">
        <div class="flex items-center gap-2 mb-2">
          <span class="pulse-dot relative inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
          <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest ml-1">Live Market Pulse</span>
        </div>
        <p id="market-blurb" class="text-sm text-slate-300 leading-relaxed">Select a city to see market conditions.</p>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="lg:col-span-8 space-y-5">

      <!-- Placeholder -->
      <div id="results-placeholder" class="glass flex flex-col items-center justify-center text-center py-28">
        <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mb-5 text-slate-700">
          <i data-lucide="building-2" class="w-8 h-8"></i>
        </div>
        <h3 class="text-lg font-h font-bold text-slate-500">Awaiting Simulation</h3>
        <p class="text-slate-700 mt-2 text-sm max-w-xs">Configure property parameters and generate a valuation.</p>
      </div>

      <!-- ML Result -->
      <div id="ml-result" class="hidden glass p-7" style="border-color:rgba(99,102,241,.25);background:rgba(99,102,241,.04)">
        <div class="flex flex-col md:flex-row justify-between items-start gap-5 mb-7">
          <div>
            <div class="flex items-center gap-2 mb-3">
              <span class="relative inline-block w-2 h-2">
                <span class="absolute inset-0 rounded-full bg-emerald-500 animate-ping opacity-60"></span>
                <span class="relative block w-2 h-2 rounded-full bg-emerald-500"></span>
              </span>
              <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">ML Validated Estimate (¬±5-8%)</span>
            </div>
            <h2 id="rent-val" class="text-6xl font-h font-bold text-white tracking-tight mb-1 rent-reveal"></h2>
            <p id="rent-range" class="text-slate-400 text-sm mt-1"></p>
            <p id="rent-meta" class="text-slate-500 text-xs mt-1.5"></p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="App.copyResult()" class="flex items-center gap-1.5 px-4 py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-xs font-semibold text-slate-300 transition-all">
              <i data-lucide="copy" class="w-3.5 h-3.5"></i>Copy
            </button>
            <button id="unlock-chat" class="flex items-center gap-1.5 px-5 py-2.5 bg-white text-slate-900 rounded-xl font-bold text-xs hover:bg-slate-100 transition-all">
              <i data-lucide="bot" class="w-3.5 h-3.5"></i>AI Strategist
            </button>
          </div>
        </div>

        <!-- Metrics -->
        <div class="grid grid-cols-3 gap-3 pt-5 border-t border-white/5">
          <div class="bg-black/20 p-4 rounded-2xl">
            <p class="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">‚Çπ / sqft</p>
            <p id="metric-psf" class="font-h font-bold text-emerald-400 text-xl">‚Äî</p>
          </div>
          <div class="bg-black/20 p-4 rounded-2xl">
            <p class="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">Furnishing</p>
            <p id="metric-furn" class="font-h font-bold text-indigo-300 text-lg">‚Äî</p>
          </div>
          <div class="bg-black/20 p-4 rounded-2xl">
            <p class="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-1">Est. Yield</p>
            <p class="font-h font-bold text-slate-300 text-xl">~3.5%</p>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div id="chat-container" class="hidden glass" style="border-color:rgba(99,102,241,.25);">
        <!-- Chat header -->
        <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between bg-black/20 rounded-t-[20px]">
          <div class="flex items-center gap-3">
            <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
            <span class="font-h font-bold text-sm text-white">AI Strategist</span>
            <!-- <span class="text-xs text-slate-600">Gemini 2.5 Flash ¬∑ Streaming</span> -->
          </div>
          <div class="flex items-center gap-3">
            <!-- Persona toggle -->
            <div class="flex gap-1.5 items-center">
              <button id="persona-tenant" class="persona-btn active-tenant" onclick="App.setPersona('tenant')">üè† Tenant</button>
              <button id="persona-owner" class="persona-btn" onclick="App.setPersona('owner')">üíº Owner</button>
            </div>
            <button onclick="App.clearChat()" class="text-xs text-slate-600 hover:text-slate-400 flex items-center gap-1 transition-colors">
              <i data-lucide="trash-2" class="w-3 h-3"></i>
            </button>
          </div>
        </div>

        <div id="chat-box" class="overflow-y-auto p-6 space-y-4 scbar" style="height:380px;background:rgba(0,0,0,.1)"></div>

        <!-- Quick prompts -->
        <div class="px-6 py-3 border-t border-white/5 flex gap-2 flex-wrap">
          <button class="text-xs px-3 py-1.5 border border-white/10 rounded-full text-slate-400 hover:text-indigo-300 hover:border-indigo-500 transition-all" onclick="App.quickPrompt('Is this a fair price?')">Fair price?</button>
          <button class="text-xs px-3 py-1.5 border border-white/10 rounded-full text-slate-400 hover:text-indigo-300 hover:border-indigo-500 transition-all" onclick="App.quickPrompt('Give me negotiation tactics for this property')">Negotiation tips</button>
          <button class="text-xs px-3 py-1.5 border border-white/10 rounded-full text-slate-400 hover:text-indigo-300 hover:border-indigo-500 transition-all" onclick="App.quickPrompt('Compare this locality with 2 nearby areas in terms of value')">Compare locality</button>
          <button class="text-xs px-3 py-1.5 border border-white/10 rounded-full text-slate-400 hover:text-indigo-300 hover:border-indigo-500 transition-all" onclick="App.quickPrompt('Give me the full Catalyst Report for this property')">Full report</button>
          <button class="text-xs px-3 py-1.5 border border-white/10 rounded-full text-slate-400 hover:text-indigo-300 hover:border-indigo-500 transition-all" onclick="App.quickPrompt('What hidden costs should I watch out for?')">Hidden costs</button>
        </div>

        <!-- Input -->
        <div class="p-4 border-t border-white/5 bg-black/20 rounded-b-[20px]">
          <div class="relative flex items-center">
            <input type="text" id="user-input" autocomplete="off" placeholder="Ask about this property..." class="ifield pr-14 py-4">
            <button id="send-btn" class="absolute right-2 bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-xl transition-all">
              <i data-lucide="send" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPARE TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-compare" class="hidden">
  <div class="mb-6">
    <h2 class="text-2xl font-h font-bold text-white">Side-by-Side Comparison</h2>
    <p class="text-sm text-slate-500 mt-1">Compare two properties to find the better deal.</p>
  </div>

  <div class="grid md:grid-cols-2 gap-5 mb-6">
    <!-- Property A -->
    <div class="glass p-6">
      <div class="flex items-center gap-2 mb-5">
        <span class="w-6 h-6 bg-indigo-500/20 border border-indigo-500/30 rounded-full text-indigo-400 text-xs font-bold flex items-center justify-center">A</span>
        <span class="text-sm font-h font-bold text-white">Property A</span>
      </div>
      <div class="space-y-3" id="cmp-a-form">
        <div class="relative"><select id="cmpA-city" class="ifield pr-8" onchange="fillCmpLoc('A')"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
        <div class="relative"><select id="cmpA-locality" class="ifield pr-8"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><select id="cmpA-bhk" class="ifield pr-6"><option value="1">1 BHK</option><option value="2" selected>2 BHK</option><option value="3">3 BHK</option><option value="4">4 BHK</option></select><i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500 pointer-events-none"></i></div>
          <input type="number" id="cmpA-area" placeholder="Area sqft" value="1000" class="ifield text-sm">
        </div>
        <div class="relative"><select id="cmpA-furn" class="ifield pr-8"><option>Unfurnished</option><option selected>Semi-Furnished</option><option>Furnished</option></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
      </div>
    </div>

    <!-- Property B -->
    <div class="glass p-6">
      <div class="flex items-center gap-2 mb-5">
        <span class="w-6 h-6 bg-purple-500/20 border border-purple-500/30 rounded-full text-purple-400 text-xs font-bold flex items-center justify-center">B</span>
        <span class="text-sm font-h font-bold text-white">Property B</span>
      </div>
      <div class="space-y-3" id="cmp-b-form">
        <div class="relative"><select id="cmpB-city" class="ifield pr-8" onchange="fillCmpLoc('B')"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
        <div class="relative"><select id="cmpB-locality" class="ifield pr-8"></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><select id="cmpB-bhk" class="ifield pr-6"><option value="1">1 BHK</option><option value="2" selected>2 BHK</option><option value="3">3 BHK</option><option value="4">4 BHK</option></select><i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500 pointer-events-none"></i></div>
          <input type="number" id="cmpB-area" placeholder="Area sqft" value="1200" class="ifield text-sm">
        </div>
        <div class="relative"><select id="cmpB-furn" class="ifield pr-8"><option>Unfurnished</option><option selected>Semi-Furnished</option><option>Furnished</option></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i></div>
      </div>
    </div>
  </div>

  <button onclick="App.runCompare()" class="btn-p px-8 py-3.5 flex items-center gap-2 text-sm mx-auto">
    <i data-lucide="git-compare" class="w-4 h-4"></i>Compare Properties
  </button>

  <!-- Compare Results -->
  <div id="cmp-results" class="hidden mt-8">
    <h3 class="text-lg font-h font-bold text-white mb-4">Comparison Results</h3>
    <div class="flex gap-4 flex-col md:flex-row" id="cmp-cards"></div>
    <div id="cmp-verdict" class="mt-5 glass p-5 text-sm text-slate-300 leading-relaxed"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-history" class="hidden">
  <div class="max-w-3xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-h font-bold text-white">Prediction History</h2>
        <p class="text-sm text-slate-500 mt-1">Last 20 valuations ¬∑ Click to reload ¬∑ Add notes</p>
      </div>
      <button onclick="App.loadHistory()" class="flex items-center gap-2 text-xs text-slate-400 hover:text-slate-200 border border-white/10 rounded-xl px-4 py-2 transition-all">
        <i data-lucide="refresh-cw" class="w-3 h-3"></i>Refresh
      </button>
    </div>
    <div id="history-list" class="space-y-3">
      <div class="text-center py-16 text-slate-600 text-sm">Loading...</div>
    </div>
  </div>
</div>

</main>

<div id="toast"></div>

<script>
const INR = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0});
const CITIES = JSON.parse(document.getElementById('cities-data').textContent);
const LOC_MAP = JSON.parse(document.getElementById('map-data').textContent);
const MARKET_BLURBS = {
  Mumbai:'Mumbai micro-markets are stable. Suburbs showing 3‚Äì5% YoY growth. Bandra/Worli premiums remain elevated.',
  Pune:'Pune IT corridors driving 4.2% rental growth this quarter. Hinjewadi and Kharadi are top performers.',
  Delhi:'Delhi NCR at record-low inventory. South Delhi premiums at all-time highs; Gurgaon sectors stabilising.'
};

// Populate compare city selects
function fillCmpLoc(ab) {
  const city = document.getElementById(`cmp${ab}-city`).value;
  const sel = document.getElementById(`cmp${ab}-locality`);
  sel.innerHTML = '';
  (LOC_MAP[city]||[]).forEach(l => sel.add(new Option(l,l)));
}

const App = {
  mlData: null,
  chatHistory: [],
  selectedBhk: 2,
  selectedFurnishing: 'Semi-Furnished',
  persona: 'tenant',
  allLocalities: [],
  currentTab: 'predict',
  isStreaming: false,

  init() {
    lucide.createIcons();
    this.fillCities();
    this.bindEvents();
    this.initCmpCities();
  },

  fillCities() {
    const sel = document.getElementById('city');
    CITIES.forEach(c => sel.add(new Option(c,c)));
    this.fillLocalities();
    this.updateMarketBlurb();
  },

  initCmpCities() {
    ['A','B'].forEach(ab => {
      const sel = document.getElementById(`cmp${ab}-city`);
      CITIES.forEach(c => sel.add(new Option(c,c)));
      fillCmpLoc(ab);
    });
  },

  fillLocalities() {
    const city = document.getElementById('city').value;
    const sel = document.getElementById('locality');
    this.allLocalities = LOC_MAP[city]||[];
    sel.innerHTML = '';
    this.allLocalities.forEach(l => sel.add(new Option(l,l)));
    document.getElementById('loc-search').value = '';
  },

  filterLocalities(q) {
    const sel = document.getElementById('locality');
    const filtered = this.allLocalities.filter(l => l.toLowerCase().includes(q.toLowerCase()));
    sel.innerHTML = '';
    filtered.forEach(l => sel.add(new Option(l,l)));
  },

  updateMarketBlurb() {
    const city = document.getElementById('city').value;
    document.getElementById('market-blurb').textContent = MARKET_BLURBS[city]||'Select a city to see market conditions.';
  },

  switchTab(tab) {
    this.currentTab = tab;
    ['predict','compare','history'].forEach(t => {
      document.getElementById(`view-${t}`).classList.toggle('hidden', t !== tab);
      document.getElementById(`tab-${t}`)?.classList.toggle('active', t === tab);
    });
    if (tab === 'history') this.loadHistory();
  },

  setPersona(p) {
    this.persona = p;
    document.getElementById('persona-tenant').className = `persona-btn ${p==='tenant'?'active-tenant':''}`;
    document.getElementById('persona-owner').className = `persona-btn ${p==='owner'?'active-owner':''}`;
  },

  bindEvents() {
    document.getElementById('city').addEventListener('change', () => {
      this.fillLocalities(); this.updateMarketBlurb();
    });
    document.getElementById('loc-search').addEventListener('input', e => this.filterLocalities(e.target.value));
    document.getElementById('predict-btn').addEventListener('click', () => this.predict());
    document.getElementById('unlock-chat').addEventListener('click', () => this.openChat());
    document.getElementById('send-btn').addEventListener('click', () => this.sendChat());
    document.getElementById('user-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendChat(); }
    });

    // BHK
    document.querySelectorAll('.bhk-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.selectedBhk = parseInt(btn.dataset.val);
        document.querySelectorAll('.bhk-btn').forEach(b =>
          b.classList.toggle('active', b === btn));
      });
    });

    // Furnishing
    document.querySelectorAll('.fc').forEach(card => {
      card.addEventListener('click', () => {
        this.selectedFurnishing = card.dataset.val;
        document.querySelectorAll('.fc').forEach(c => c.classList.toggle('active', c === card));
      });
    });

    // Area sync
    const slider = document.getElementById('area-slider');
    const areaIn = document.getElementById('area');
    const adisp = document.getElementById('area-display');
    slider.addEventListener('input', () => { areaIn.value = slider.value; adisp.textContent = `${slider.value} sqft`; });
    areaIn.addEventListener('input', () => {
      const v = Math.min(5000, Math.max(200, parseInt(areaIn.value)||1000));
      slider.value = v; adisp.textContent = `${v} sqft`;
    });
  },

  async predict() {
    const btn = document.getElementById('predict-btn');
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg><span>Analysing...</span>`;

    try {
      const res = await fetch('/predict', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          city: document.getElementById('city').value,
          locality: document.getElementById('locality').value,
          bhk: this.selectedBhk,
          area: parseFloat(document.getElementById('area').value)||1000,
          furnishing: this.selectedFurnishing
        })
      });
      this.mlData = await res.json();
      this.showResult();
      this.calcAffordability();
    } catch(e) { this.showToast('Prediction failed. Check console.'); }
    finally {
      btn.disabled = false; btn.innerHTML = orig; lucide.createIcons();
    }
  },

  showResult() {
    const d = this.mlData;
    const avg = (d.fair_rent_low + d.fair_rent_high) / 2;
    const psf = (avg / d.area).toFixed(0);
    document.getElementById('results-placeholder').classList.add('hidden');
    const card = document.getElementById('ml-result');
    card.classList.remove('hidden');
    const el = document.getElementById('rent-val');
    el.classList.remove('rent-reveal');
    void el.offsetWidth;
    el.classList.add('rent-reveal');
    el.textContent = INR.format(avg);
    document.getElementById('rent-range').textContent = `Range: ${INR.format(d.fair_rent_low)} ‚Äì ${INR.format(d.fair_rent_high)}`;
    document.getElementById('rent-meta').textContent = `${d.bhk} BHK ¬∑ ${d.area} sqft ¬∑ ${d.furnishing} ¬∑ ${d.locality}, ${d.city}`;
    document.getElementById('metric-psf').textContent = `‚Çπ${psf}`;
    document.getElementById('metric-furn').textContent = d.furnishing;
    lucide.createIcons();
  },

  calcAffordability() {
    if (!this.mlData) return;
    const salary = parseFloat(document.getElementById('salary-input').value);
    if (!salary || salary <= 0) return;
    const avg = (this.mlData.fair_rent_low + this.mlData.fair_rent_high) / 2;
    const pct = (avg / salary) * 100;
    const fill = document.getElementById('afford-fill');
    const pctEl = document.getElementById('afford-pct');
    const msg = document.getElementById('afford-msg');
    document.getElementById('afford-hint').classList.add('hidden');
    document.getElementById('afford-result').classList.remove('hidden');
    pctEl.textContent = `${pct.toFixed(1)}%`;
    const w = Math.min(100, pct);
    fill.style.width = `${w}%`;
    if (pct <= 30) {
      fill.style.background = '#22c55e';
      pctEl.style.color = '#4ade80';
      msg.textContent = `‚úÖ Healthy! ${pct.toFixed(1)}% of income. The 30% rule says this is financially comfortable.`;
    } else if (pct <= 45) {
      fill.style.background = '#f59e0b';
      pctEl.style.color = '#fbbf24';
      msg.textContent = `‚ö†Ô∏è Stretched. At ${pct.toFixed(1)}% of income you have limited savings room. Consider negotiating.`;
    } else {
      fill.style.background = '#ef4444';
      pctEl.style.color = '#f87171';
      msg.textContent = `‚ùå Overextended. ${pct.toFixed(1)}% of income is above safe limits. Look at lower-cost localities.`;
    }
  },

  openChat() {
    const chat = document.getElementById('chat-container');
    chat.classList.remove('hidden');
    document.getElementById('unlock-chat').classList.add('hidden');
    setTimeout(() => document.getElementById('user-input').focus(), 200);
  },

  clearChat() {
    this.chatHistory = [];
    document.getElementById('chat-box').innerHTML = '';
  },

  quickPrompt(text) {
    document.getElementById('user-input').value = text;
    this.sendChat();
  },

  async sendChat() {
    if (this.isStreaming) return;
    const input = document.getElementById('user-input');
    const val = input.value.trim();
    if (!val || !this.mlData) return;

    this.chatHistory.push({role:'user', text:val});
    this.renderChat();
    input.value = '';
    this.isStreaming = true;

    // Add AI bubble placeholder
    const box = document.getElementById('chat-box');
    const aiId = 'ai-' + Date.now();
    box.insertAdjacentHTML('beforeend', `
      <div id="${aiId}" class="flex justify-start">
        <div class="ai-bubble max-w-[88%] p-4 rounded-2xl text-sm text-slate-200 leading-relaxed stream-cursor prose prose-invert prose-sm max-w-none"></div>
      </div>`);
    box.scrollTop = box.scrollHeight;

    const bubble = document.querySelector(`#${aiId} div`);
    let fullText = '';

    try {
      const response = await fetch('/chat/stream', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          user_question: val,
          ml_data: this.mlData,
          chat_history: this.chatHistory.slice(0,-1).map(h=>`${h.role}: ${h.text}`).join('\n'),
          persona: this.persona
        })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const payload = line.slice(6);
          if (payload === '[DONE]') break;
          if (payload.startsWith('[ERROR]')) {
            bubble.textContent = payload; break;
          }
          // Restore newlines
          fullText += payload.replace(/\\n/g, '\n');
          bubble.innerHTML = marked.parse(fullText);
          box.scrollTop = box.scrollHeight;
        }
      }
    } catch(e) {
      bubble.textContent = 'Connection failed. Please try again.';
    }

    // Remove streaming cursor, finalize
    bubble.classList.remove('stream-cursor');
    this.chatHistory.push({role:'ai', text: fullText});
    this.isStreaming = false;
  },

  renderChat() {
    const box = document.getElementById('chat-box');
    box.innerHTML = this.chatHistory.map(h => `
      <div class="flex ${h.role==='user'?'justify-end':'justify-start'}">
        <div class="max-w-[88%] p-4 rounded-2xl text-sm leading-relaxed ${
          h.role==='user'
            ? 'user-bubble text-white'
            : 'ai-bubble text-slate-200 prose prose-invert prose-sm max-w-none'
        }">
          ${h.role==='user' ? this.esc(h.text) : marked.parse(h.text)}
        </div>
      </div>`).join('');
    box.scrollTop = box.scrollHeight;
  },

  esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); },

  copyResult() {
    if (!this.mlData) return;
    const d = this.mlData;
    const avg = (d.fair_rent_low + d.fair_rent_high) / 2;
    const text = `SmartRentAI Valuation Report\n${'‚îÄ'.repeat(32)}\nProperty : ${d.bhk} BHK, ${d.area} sqft, ${d.furnishing}\nLocation : ${d.locality}, ${d.city}\nFair Rent: ${INR.format(avg)}/month\nRange    : ${INR.format(d.fair_rent_low)} ‚Äì ${INR.format(d.fair_rent_high)}\nPer sqft : ‚Çπ${(avg/d.area).toFixed(0)}\nEst. Yield: ~3.5% p.a.\n${'‚îÄ'.repeat(32)}\nPowered by SmartRentAI`;
    navigator.clipboard.writeText(text).then(() => this.showToast('Copied to clipboard!'));
  },

  async runCompare() {
    const read = (ab) => ({
      city: document.getElementById(`cmp${ab}-city`).value,
      locality: document.getElementById(`cmp${ab}-locality`).value,
      bhk: parseInt(document.getElementById(`cmp${ab}-bhk`).value),
      area: parseFloat(document.getElementById(`cmp${ab}-area`).value)||1000,
      furnishing: document.getElementById(`cmp${ab}-furn`).value,
    });

    const btn = event.target.closest('button');
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg><span>Comparing...</span>`;

    try {
      const res = await fetch('/compare',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ properties:[read('A'), read('B')] })
      });
      const data = await res.json();
      this.showCompareResults(data);
    } catch(e) { this.showToast('Compare failed.'); }
    finally { btn.disabled=false; btn.innerHTML=orig; lucide.createIcons(); }
  },

  showCompareResults(results) {
    const [a, b] = results;
    const winner = a.avg <= b.avg ? 0 : 1;
    const labels = ['A','B'];
    const colors = ['text-indigo-400','text-purple-400'];
    const borderCls = ['border-indigo-500/30','border-purple-500/30'];

    document.getElementById('cmp-results').classList.remove('hidden');
    document.getElementById('cmp-cards').innerHTML = results.map((r,i) => `
      <div class="cmp-card ${i===winner?'cmp-winner':''}">
        <div class="flex items-center gap-2 mb-4">
          <span class="w-6 h-6 rounded-full ${i===0?'bg-indigo-500/20':'bg-purple-500/20'} ${i===0?'border-indigo-500/30':'border-purple-500/30'} border flex items-center justify-center text-xs font-bold ${colors[i]}">${labels[i]}</span>
          <span class="text-sm font-h font-bold text-white">${r.locality}, ${r.city}</span>
          ${i===winner?'<span class="ml-auto text-xs font-bold text-emerald-400 bg-emerald-500/10 border border-emerald-500/20 px-2 py-0.5 rounded-full">‚úì Better Deal</span>':''}
        </div>
        <p class="text-3xl font-h font-bold text-white mb-1">${INR.format(r.avg)}</p>
        <p class="text-xs text-slate-500 mb-4">${INR.format(r.fair_rent_low)} ‚Äì ${INR.format(r.fair_rent_high)}</p>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between"><span class="text-slate-500">Config</span><span class="font-semibold">${r.bhk} BHK ¬∑ ${r.area} sqft</span></div>
          <div class="flex justify-between"><span class="text-slate-500">Furnishing</span><span class="font-semibold">${r.furnishing}</span></div>
          <div class="flex justify-between"><span class="text-slate-500">‚Çπ/sqft</span><span class="font-semibold text-emerald-400">‚Çπ${(r.avg/r.area).toFixed(0)}</span></div>
        </div>
      </div>`).join('');

    const diff = Math.abs(a.avg - b.avg);
    const pctDiff = ((diff / Math.max(a.avg, b.avg)) * 100).toFixed(1);
    const cheaperLabel = winner === 0 ? `Property A (${a.locality})` : `Property B (${b.locality})`;
    document.getElementById('cmp-verdict').innerHTML = `
      <div class="flex items-start gap-3">
        <span class="text-2xl">üèÜ</span>
        <div>
          <p class="font-h font-bold text-white mb-1">Verdict: ${cheaperLabel} is the better deal</p>
          <p class="text-slate-400">At ${INR.format(diff)}/month cheaper (${pctDiff}% lower), ${cheaperLabel} offers superior value at the same configuration. 
          The ‚Çπ/sqft metric of <strong class="text-emerald-400">‚Çπ${(Math.min(a.avg/a.area, b.avg/b.area)).toFixed(0)}</strong> confirms the price efficiency.
          Over a 12-month lease this compounds to savings of <strong class="text-white">${INR.format(diff*12)}</strong>.</p>
        </div>
      </div>`;
  },

  async loadHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = `<div class="text-center py-12 text-slate-600 text-sm flex items-center justify-center gap-2">
      <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>Loading...</div>`;
    try {
      const res = await fetch('/history');
      const data = await res.json();
      if (!data.length) {
        list.innerHTML = `<div class="text-center py-20 text-slate-600 text-sm">No predictions yet. Go to <strong class="text-slate-400">Predict</strong> tab to get started.</div>`;
        return;
      }
      list.innerHTML = data.map((r,i) => {
        const avg = (r.fair_rent_low + r.fair_rent_high) / 2;
        const date = r.created_at ? new Date(r.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'2-digit'}) : '';
        const safeR = JSON.stringify(r).replace(/'/g,"\\'");
        return `
        <div class="glass p-5 hover:border-indigo-500/30 transition-colors" style="border-color:var(--border)">
          <div class="flex flex-col sm:flex-row justify-between gap-3">
            <div class="cursor-pointer flex-1" onclick='App.loadFromHistory(${JSON.stringify(r)})'>
              <div class="flex items-center gap-2 mb-1">
                <p class="font-h font-bold text-white text-lg">${INR.format(avg)}</p>
                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full border text-slate-500 border-white/10">${r.furnishing}</span>
              </div>
              <p class="text-slate-400 text-xs">${r.bhk} BHK ¬∑ ${r.area} sqft ¬∑ ${r.locality}, ${r.city}</p>
              <p class="text-slate-600 text-xs mt-1">Range: ${INR.format(r.fair_rent_low)} ‚Äì ${INR.format(r.fair_rent_high)} ¬∑ ‚Çπ${(avg/r.area).toFixed(0)}/sqft</p>
            </div>
            <div class="text-right shrink-0">
              <p class="text-xs text-slate-600 font-medium mb-2">${date}</p>
              <button onclick="App.switchTab('predict')" class="text-xs text-indigo-400 hover:text-indigo-300 border border-indigo-500/20 hover:border-indigo-500/40 px-3 py-1 rounded-lg transition-all">Load ‚Üí</button>
            </div>
          </div>
          <!-- Inline note -->
          <div class="mt-3 pt-3 border-t border-white/5">
            <textarea class="note-input" rows="1" placeholder="Add a private note..." 
              data-ts="${r.timestamp||''}"
              onchange="App.saveNote(this)">${r.note||''}</textarea>
          </div>
        </div>`;
      }).join('');
    } catch(e) {
      list.innerHTML = `<div class="text-center py-12 text-red-400 text-sm">Failed to load history.</div>`;
    }
  },

  loadFromHistory(record) {
    this.mlData = record;
    this.switchTab('predict');
    this.showResult();
    this.showToast('Loaded from history!');
  },

  async saveNote(textarea) {
    const ts = textarea.dataset.ts;
    const note = textarea.value;
    try {
      await fetch('/history/note', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({timestamp: ts, note})
      });
      this.showToast('Note saved.');
    } catch(e) {}
  },

  showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
